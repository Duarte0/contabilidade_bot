<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sistema de Mensagens WhatsApp</title>
    <!-- Favicon inline para evitar 404 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Cpath d='M18 36l6 6 22-22' stroke='white' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons UMD (garante window.lucide dispon칤vel) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
    
    <!-- Configura칞칚o da API -->
    <script src="config.js?v=nocache1732736500" defer></script>
    
    <!-- Cache bust para CSS -->
    <link rel="stylesheet" href="style.css?v=nocache1732736500">
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-icon">
                    <i data-lucide="message-circle"></i>
                </div>
                <div>
                    <h1>Sistema de Mensagens WhatsApp</h1>
                    <p class="subtitle">
                        <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                        Envio em lote via Digisac API
                    </p>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('enviar')">
                <i data-lucide="send"></i>
                <span>Enviar em Lote</span>
            </button>
            <button class="tab" onclick="showTab('dashboard')">
                <i data-lucide="bar-chart-3"></i>
                <span>Dashboard</span>
            </button>
            <button class="tab" onclick="showTab('templates')">
                <i data-lucide="file-text"></i>
                <span>Templates</span>
            </button>
        </div>

        <!-- TAB: Enviar em Lote -->
        <div id="tab-enviar" class="tab-content active">
            <div class="card">
                <h2 class="card-title">
                    <i data-lucide="send" style="width: 24px; height: 24px;"></i>
                    Enviar Mensagens em Lote
                </h2>
                
                <!-- Buscar Clientes -->
                <div class="form-group">
                    <label>
                        <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                        Buscar Clientes
                    </label>
                    <div class="search-box">
                        <div class="input-with-icon">
                            <i data-lucide="search" class="input-icon"></i>
                            <input type="text" id="searchClientes" placeholder="Digite o nome do cliente..." onkeyup="buscarClientesDebounced()">
                        </div>
                        <button class="btn btn-primary" onclick="carregarClientes()">
                            <i data-lucide="users"></i>
                            <span>Carregar Todos</span>
                        </button>
                    </div>
                </div>

                <!-- Lista de Clientes -->
                <div class="form-group">
                    <label>
                        <i data-lucide="user-check" style="width: 16px; height: 16px;"></i>
                        Selecionar Clientes
                    </label>
                    <div id="selectedCount" class="selected-count" style="display:none;">
                        <i data-lucide="check-circle"></i>
                        <span>0 clientes selecionados</span>
                    </div>
                    <div id="clientesLista" class="clientes-grid">
                        <div class="empty-state">
                            <i data-lucide="users" style="width: 48px; height: 48px;"></i>
                            <p>Carregue os clientes para come칞ar</p>
                        </div>
                    </div>
                </div>

                <!-- Tipo de Mensagem -->
                <div class="form-group">
                    <label>
                        <i data-lucide="tag" style="width: 16px; height: 16px;"></i>
                        Tipo de Mensagem
                    </label>
                    <div class="select-wrapper">
                        <i data-lucide="tag" class="select-icon"></i>
                        <select id="tipoCobranca" onchange="atualizarTemplates()">
                            <option value="financeira">游눯 Cobran칞a Financeira</option>
                            <option value="documento">游늯 Solicita칞칚o de Documentos</option>
                        </select>
                    </div>
                </div>

                <!-- Template -->
                <div class="form-group">
                    <label>
                        <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                        Template (Opcional)
                    </label>
                    <div class="select-wrapper">
                        <i data-lucide="file-text" class="select-icon"></i>
                        <select id="templateSelect">
                            <option value="">Usar mensagem personalizada</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="previewTemplate()">
                        <i data-lucide="eye"></i>
                        <span>Pr칠-visualizar</span>
                    </button>
                </div>

                <!-- Vari치veis Extras -->
                <div class="form-group">
                    <label>Vari치veis Personalizadas</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <input type="text" id="var_valor" placeholder="Valor (ex: 150,00)" style="width: 100%;">
                            <small>
                                Insira no texto: <code>${valor}</code>
                                <button class="btn btn-ghost" style="padding:4px 8px; font-size:12px;" onclick="insertVar('valor')">Inserir</button>
                            </small>
                        </div>
                        <div>
                            <input type="text" id="var_dia_vencimento" placeholder="Dia vencimento (ex: 10)" style="width: 100%;">
                            <small>
                                Insira no texto: <code>${dia_vencimento}</code>
                                <button class="btn btn-ghost" style="padding:4px 8px; font-size:12px;" onclick="insertVar('dia_vencimento')">Inserir</button>
                            </small>
                        </div>
                        <div>
                            <input type="text" id="var_data_vencimento" placeholder="Data vencimento (ex: 10/12/2025)" style="width: 100%;">
                            <small>
                                Insira no texto: <code>${data_vencimento}</code>
                                <button class="btn btn-ghost" style="padding:4px 8px; font-size:12px;" onclick="insertVar('data_vencimento')">Inserir</button>
                            </small>
                        </div>
                        <div>
                            <input type="text" id="var_descricao" placeholder="Descri칞칚o/observa칞칚o" style="width: 100%;">
                            <small>
                                Insira no texto: <code>${descricao}</code>
                                <button class="btn btn-ghost" style="padding:4px 8px; font-size:12px;" onclick="insertVar('descricao')">Inserir</button>
                            </small>
                        </div>
                    </div>
                    <small>
                        Dica: preencha os campos acima e use as vari치veis no texto com o formato <code>${variavel}</code>.
                        Vari치veis autom치ticas dispon칤veis: <code>${nome}</code>, <code>${data_hoje}</code>, <code>${dia_semana}</code>, <code>${mes_ano}</code>, <code>${empresa}</code>.
                    </small>
                </div>

                <!-- Editor de Mensagem -->
                <div class="form-group">
                    <label>
                        <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
                        Mensagem Padr칚o
                    </label>
                    <textarea id="mensagemPadrao" placeholder="Digite sua mensagem... Use ${nome} para o nome do cliente">Ol치 ${nome}!

Espero que esteja tudo bem!

Estou entrando em contato para...

Fico no aguardo do seu retorno.

Obrigado!</textarea>
                </div>

                <!-- Preview -->
                <div id="previewBox" class="preview-box" style="display:none;">
                    <div class="preview-title">Preview da Mensagem</div>
                    <div id="previewContent" class="preview-message"></div>
                </div>

                <!-- Bot칫es de A칞칚o -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="enviarLote()">
                        <i data-lucide="send"></i>
                        <span>Enviar Agora</span>
                    </button>
                    <button class="btn btn-secondary" onclick="limparFormulario()">
                        <i data-lucide="refresh-cw"></i>
                        <span>Limpar</span>
                    </button>
                </div>

                <!-- Resultado -->
                <div id="resultBox" style="display:none;"></div>
            </div>
        </div>

        <!-- TAB: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando estat칤sticas...</p>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i data-lucide="activity" style="width: 24px; height: 24px;"></i>
                    Atividades Recentes
                </h2>
                <div id="atividadesRecentes">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Templates -->
        <div id="tab-templates" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">
                        <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
                        Gerenciar Templates
                    </h2>
                    <button class="btn btn-primary" onclick="abrirModalNovoTemplate()">
                        <i data-lucide="plus"></i>
                        <span>Novo Template</span>
                    </button>
                </div>
                
                <div id="templatesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Carregando templates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Template -->
    <div id="modalTemplate" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTemplateTitle">Novo Template</h3>
                <button class="modal-close" onclick="fecharModalTemplate()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="templateIdEdit">
                <input type="hidden" id="templateNomeOriginal">
                
                <div class="form-group">
                    <label>Nome do Template *</label>
                    <input type="text" id="templateNome" placeholder="Ex: Cobran칞a Padr칚o" required>
                    <small>Use um nome 칰nico e descritivo</small>
                </div>

                <div class="form-group">
                    <label>Texto do Template *</label>
                    <textarea id="templateTexto" rows="8" placeholder="Digite o texto do template...

Use vari치veis como:
${nome} - Nome do cliente
${valor} - Valor
${dia_vencimento} - Dia do vencimento
${data_vencimento} - Data completa
${descricao} - Descri칞칚o adicional" required></textarea>
                    <small>Use ${variavel} para inserir valores din칙micos</small>
                </div>

                <div class="form-group">
                    <label>Vari치veis Dispon칤veis</label>
                    <input type="text" id="templateVariaveis" placeholder="Ex: nome, valor, dia_vencimento, data_vencimento">
                    <small>Separe por v칤rgula. Deixe vazio para usar as vari치veis padr칚o.</small>
                </div>

                <div class="form-group" id="templateAtivoGroup" style="display: none;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="templateAtivo" checked style="margin-right: 8px;">
                        Template Ativo
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalTemplate()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarTemplate()">
                    <i data-lucide="save"></i>
                    <span>Salvar</span>
                </button>
            </div>
        </div>
    </div>
    </div>

    <script src="app.js?v=nocache1732736500" defer></script>
    <script>
        // Inicializar 칤cones Lucide de forma segura ap칩s load
        window.addEventListener('load', () => {
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
